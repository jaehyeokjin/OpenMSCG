import pytest
from mscg.cli import cgfm



def test_1s(datafile):
    
    coeffs = cgfm.main(
        top     = datafile("methanol_1728.data"),
        traj    = datafile("methanol_1728_cg.trr"),
        names   = 'MeOH',
        cut     = 8.0,
        pair    = ['model=BSpline,type=MeOH:MeOH,min=2.8,max=8.0,resolution=0.2'],
        verbose = 0,
        save    = 'return'
    )
    
    benchmark = [24.633855990147723, 23.254356189770814, 13.742183191466255, 8.066460945652503, 2.089070163578911, 0.9748660197352128, -1.6689624414472763, 0.10626734961838016, 2.361066520731877, 0.8078495038128483, 0.7803368379619063, 0.24987649631564085, 0.2116966503224922, -0.035525549564649914, -0.02255014663431014, -0.04360709281999547, -0.001564214762449591, -0.07324450585069074, -0.062445019915651725, -0.07501027650669777, 0.03601538415514855, 0.07943874830078775, 0.10310592792556607, 0.1004287438352687, 0.05333777208027316, 0.06750969535123706, 0.04305034009871422, 0.001959103271945271, 0.05084091216999158, -0.015622231500833871, 0.01731119198470998]
    
    print("Coeffs: " + ", ".join([str(_) for _ in coeffs]))
    
    for i in range(20):
        diff = (coeffs[i] - benchmark[i]) / benchmark[i]
        print("X=%3d, Y0=%10.3e, Y=%10.3e, dY/Y0=%5.2f%%" %(i+1, benchmark[i], coeffs[i], diff))
        assert abs(diff)<0.01



def test_2s(datafile):
    
    coeffs = cgfm.main(
        top     = datafile("methanol_1728_2s.data"),
        traj    = datafile("methanol_1728_2s.trr,frames=500"),
        names   = 'CH3,OH',
        cut     = 8.0,
        pair    = ['model=BSpline,type=CH3:CH3,min=2.9,max=8.0', 'model=BSpline,type=CH3:OH,min=2.8,max=8.0', 'model=BSpline,type=OH:OH,min=2.5,max=8.0'],
        bond    = ['model=BSpline,type=CH3:OH,min=1.35,max=1.65,resolution=0.01'],
        verbose = 0,
        save    = 'return'
    )
    
    print("Coeffs: " + ", ".join([str(_) for _ in coeffs]))
    
    benchmark = [17.649808509810928, 18.984506064579374, 18.12183978965839, 13.66927668136569, 11.970209378678204, 8.27335924960914, 6.506060672785908, 4.663554971685366, 3.646778397751063, 2.6409616586528366, 1.910123331134019, 1.372325283736429, 0.9008927240371106, 0.6261693825752456, 0.35981814113073607, 0.22349289470865583, 0.1399045835396545, 0.05932910362203247, 0.1327360373536152, -0.05099366492436508, 0.09140362992615088, -0.02171575704990499, 0.005392857873347337, 0.007405979484781305, -0.02381656509016049, -0.03726177070070376, -0.0015291554426078312, -0.07067245118465904, 0.002649388926792507, -0.07686406698707009, -0.037681821201574935, -0.02578520557702112, -0.05301432671224941, 0.0064129969350765065, -0.05058314827191421, -0.03871525658264741, 0.008236995489574735, -0.04440730364861225, 0.0018789020375345141, -0.01348331927882653, -0.05434892097037522, 0.04997110777175152, -0.0939198956232159, 0.031740699900371226, -0.02651724524079651, 0.014764457687933432, -0.007058791761785937, 0.016142504740240954, -0.013944629978177012, 0.021464937201857655, 0.002332025582380749, 0.03186950634054893, -0.008957950741184242, 0.07083022354273329, -0.07234361523309009, 0.03044701133785198, 14.048877557241687, 10.850317282395155, 9.688001395551698, 7.623715476484, 5.531194235429239, 3.879713451240335, 2.3382740673777196, 1.444315919646458, 0.6955302174121528, 0.24262654941999137, -0.09753793671248744, -0.3493924387636283, -0.35913374930547026, -0.4460573163873412, -0.43970539098911104, -0.37631614418695725, -0.2540531545325974]
    
    print("")
    
    for i in range(20):
        diff = (coeffs[i] - benchmark[i]) / benchmark[i]
        print("X=%3d, Y0=%10.3e, Y=%10.3e, dY/Y0=%5.2f%%" %(i+1, benchmark[i], coeffs[i], diff))
        assert abs(diff)<0.01
